(function(){function t(t){var e=this;e.parent=t,"ontouchstart"in window?e.initTouch():"onmousedown"in window&&(e.mouse=!0)}function e(){this.data=[],this.last=0}function n(t){this.options=t,this.init()}t.prototype={threshold:5,initTouch:function(){var t=this,e=t.touchHandler.bind(t);t.touch=!0,t.parent.addEventListener("touchstart",e,!1),t.parent.addEventListener("touchmove",e,!1),t.parent.addEventListener("touchend",e,!1),t.touches={},t.data=[]},findItem:function(t){var e,i,n=this.data;for(e=0;e<n.length;e++)if(i=n[e],i.element===t)return i},addListener:function(t,e,n){var r=this;if(r.mouse&&t.addEventListener(e,n,!1),r.touch){var a=r.findItem(t);a?i=a.events[e]:(a={element:t,events:{}},r.data.push(a),i=null),i||(a.events[e]=i=[]),i.push(n)}},removeListener:function(t,e,i){var n=this;if(n.mouse&&t.removeEventListener(e,i,!1),n.touch){var r,a,s=n.findItem(t);s&&(r=s.events[e],r&&(a=r.indexOf(i),a>=0&&r.splice(a,1)))}},ignore:function(){},fire:function(t,e){for(var i=this,n=function(n){var r,s=null;for(r=0;r<i.data.length;r++)if(i.data[r].element===n){s=i.data[r];break}if(s){var o=s.events[t];o&&i.forEach(o,function(r){var s,o={type:t};for(s in e)o[s]=e[s];o.preventDefault=i.ignore,o.stopPropagation=a,r.call(n,o)})}},r=!1,a=function(){r=!0},s=e.target;s&&(n(s),!r&&s!==i.parent);)s=s.parentNode},forEach:function(t,e){Array.prototype.forEach.call(t,e)},touchHandler:function(t){var e=this;t.preventDefault(),"touchstart"==t.type?e.forEach(t.changedTouches,function(t){e.touches[t.identifier]={evt:t},e.fire("mousedown",t)}):"touchmove"==t.type?e.forEach(t.changedTouches,function(t){var i=e.touches[t.identifier],n=i.evt;i.moved=i.moved||Math.abs(t.clientX-n.clientX)>e.threshold||Math.abs(t.clientY-n.clientY)>e.threshold,i.moved&&(i.evt=t,e.fire("mousemove",t))}):"touchend"==t.type&&e.forEach(t.changedTouches,function(t){e.fire("mouseup",t);var i=e.touches[t.identifier];delete e.touches[t.identifier],i&&!i.moved&&e.fire("click",t)})},getPoint:function(t){if("offsetX"in t)return{x:t.offsetX,y:t.offsetY};var e=t.target.getBoundingClientRect(),i=document.documentElement,n=window;return{x:t.pageX-(e.left+n.pageXOffset-i.clientLeft),y:t.pageY-(e.top+n.pageYOffset-i.clientTop)}}},e.prototype={setLyric:function(t){var e=this.data=[];if(this.last=0,t){var i=/^\[([^\]]*)\]\s*(.*)$/;t.split(/\n/).forEach(function(t){var n=t.match(i);if(n){var r=0;n[1].split(/:/).forEach(function(t){r=60*r+Number(t)}),e.push([r,n[2]])}})}},getLyricAtTime:function(t){var e,i=this,n=i.data,r=i.last,a=n[r]||n[r=0];if(a)if(a[0]<t){for(;(e=n[++r])&&e[0]<=t;)a=e;i.last=r-1}else{for(;a&&a[0]>t;)a=n[--r];i.last=r}return a?a[1]:""}},n.prototype={_classes:{list:"fa fa-list",prev:"fa fa-step-backward",play:"fa fa-play",next:"fa fa-step-forward",pause:"fa fa-pause"},extend:function(t,e){for(var i in e)t[i]=e[i];return t},init:function(){var t=this,i=t.options.container;t.classes=t.extend({},t._classes),t.options.classes&&t.extend(t.classes,t.options.classes),i.classList.add("ge-player"),i.innerHTML='<div class="image"></div><div class="buttons"><i data="list" class="button '+t.classes.list+'"></i></div><div class="control"><div class="title"></div><div class="artist"></div><i data="prev" class="button '+t.classes.prev+'"></i><i data="play" class="button '+t.classes.play+'"></i><i data="next" class="button '+t.classes.next+'"></i></div><div class="progress"><div class="wrap"><div class="barwrap"><div class="bar"><div class="played"></div></div></div><div class="cursor"></div><div class="time"></div></div></div><div class="lyric"></div><div class="playlist hide"></div>',t.image=i.querySelector(".image"),t.title=i.querySelector(".title"),t.artist=i.querySelector(".artist"),t.playlist=i.querySelector(".playlist"),t.prwrap=i.querySelector(".barwrap"),t.prcur=i.querySelector(".cursor"),t.prtime=i.querySelector(".time"),t.brplayed=i.querySelector(".played"),t.lyric=i.querySelector(".lyric"),Array.prototype.forEach.call(i.querySelectorAll(".button[data]"),function(e){t["bt"+e.getAttribute("data")]=e}),t.audio=new Audio,t.options.image&&(t.image.innerHTML='<img src="'+t.safeHTML(t.options.image)+'">'),t.setSongs([]),t.lyricParser=new e,t.bindEvents()},bindEvents:function(){var e=this,i=null,n=new t(e.options.container);n.addListener(e.btlist,"click",function(t){this.classList.toggle("active"),e.playlist.classList.toggle("hide")}),n.addListener(e.btprev,"click",function(t){e.play(e.previous())}),n.addListener(e.btnext,"click",function(t){e.play(e.next())}),n.addListener(e.btplay,"click",function(t){e.current<0?e.play(0):e.audio.paused?e.audio.play():e.audio.pause()}),e.audio.addEventListener("ended",function(t){e.play(e.next())},!1),e.audio.addEventListener("timeupdate",function(t){var n=this.currentTime,r=e.duration;if(r||(r=e.duration=this.duration),!i){var a=r?n/r*100+"%":0;e.prcur.style.left=a,e.brplayed.style.width=a}e.prtime.innerHTML=e.timestr(n)+" / "+e.timestr(r),e.lyric.innerHTML=e.safeHTML(e.lyricParser.getLyricAtTime(n))},!1);var r=function(t){var i=["play","pause"];"pause"==t.type&&i.reverse();var n=e.btplay.classList;e.classes[i[0]].split(/\s+/).forEach(function(t){n.remove(t)}),e.classes[i[1]].split(/\s+/).forEach(function(t){n.add(t)}),e.image.classList["play"==t.type?"add":"remove"]("ge-roll")};e.audio.addEventListener("play",r,!1),e.audio.addEventListener("pause",r,!1),n.addListener(e.playlist,"click",function(t){var i=Array.prototype.indexOf.call(this.childNodes,t.target);i>=0&&e.play(i)});var a=function(t,i){var n=t/e.prwrap.offsetWidth;0>n?n=0:n>1&&(n=1),e.prcur.style.left=e.brplayed.style.width=100*n+"%",i&&(e.audio.currentTime=~~(n*e.duration))};n.addListener(e.prwrap,"click",function(t){t.preventDefault();var e=n.getPoint(t).x;a(e,!0)});var s=function(t){i&&(i.moved=!0,a(t.clientX-i.delta))},o=function(t){i&&(t.preventDefault(),i=null)},c=function(t){i&&(a(t.clientX-i.delta,!0),o(t))},l=function(t){t.preventDefault(),i={delta:t.clientX-e.brplayed.offsetWidth}};n.addListener(e.prcur,"mousedown",l),n.addListener(e.options.container,"mousemove",s),n.addListener(e.options.container,"mouseup",c),e.options.container.addEventListener("mouseleave",o,!1)},safeHTML:function(t){return t.replace(/[&"<]/g,function(t){return{"&":"&amp;",'"':"&quot;","<":"&lt;"}[t]})},setSongs:function(t){var e=this,i=[];e.songs=t,e.songs.forEach(function(t){var n=e.safeHTML(t.name);i.push('<div title="'+n+'">'+n+"</div>")}),e.playlist.innerHTML=i.join(""),e.current=-1,e.duration=0},getLyric:function(){var t=this,e=t.songs[t.current];if("lyric"in e)t.lyricParser.setLyric(e.lyric);else if(t.lyricParser.setLyric(),"lyricjsonp"in e){var i="setLyric"+Date.now().toString(16)+(~~(65535*Math.random())).toString(16);window[i]=function(n){200!=n.code?e.lyric=null:(e.lyric=n.lyric,e===t.songs[t.current]&&t.lyricParser.setLyric(e.lyric)),delete window[i]};var n=document.createElement("script");n.src=e.lyricjsonp+(/\?/.test(e.lyricjsonp)?"&":"?")+"jsonp="+i,n.onload=function(){document.body.removeChild(n)},document.body.appendChild(n)}},play:function(t){var e=this;if(t>=0&&t<e.songs.length){if(e.current==t)e.audio.currentTime=0;else{var i=e.playlist.childNodes,n=i[e.current];n&&n.classList.remove("active"),e.current=t,i[e.current].classList.add("active");var r=e.songs[e.current];e.title.innerHTML=e.safeHTML(r.name),e.artist.innerHTML=e.safeHTML(r.artist||""),e.audio.src=r.url,e.duration=r.duration?r.duration/1e3:null;var a=r.image||e.options.image;a&&(e.image.innerHTML='<img src="'+e.safeHTML(a)+'">'),e.lyric.innerHTML="",e.getLyric()}e.prtime.innerHTML="",e.prcur.style.left=0,e.brplayed.style.width=0,e.audio.play()}},previous:function(){return(this.current-1)%this.songs.length},next:function(){return(this.current+1)%this.songs.length},timestr:function(t){if(isNaN(t))return"??:??";var e=Math.floor(t/60);return t=Math.floor(t)%60,10>t&&(t="0"+t),10>e&&(e="0"+e),e+":"+t}},window.Player=n}).call({});