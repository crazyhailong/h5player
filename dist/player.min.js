/**
 * H5Player - A simple but powerful HTML5 music player
 * @version v1.2.0
 * @license MIT
 * @author Gerald <gera2ld@163.com>
 */
(function(){"use strict";function t(){this.data=[],this.last=0}function e(t){var e=new CustomEvent("PlayerEvent",{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(e)}function i(t,e){for(var i in e)t[i]=e[i];return t}function s(t){r=t,n.forEach(function(e){t!==e&&e.audio.pause()})}function a(t){this.options=t,this.init(),n.push(this)}t.prototype={setLyric:function(t){var e=this.data=[];if(this.last=0,t){var i=/^\[([^\]]*)\]\s*(.*)$/;t.split(/\n/).forEach(function(t){var s=t.match(i);if(s){var a=0;s[1].split(/:/).forEach(function(t){a=60*a+Number(t)}),e.push([a,s[2]])}})}},getLyricAtTime:function(t){var e,i=this,s=i.data,a=i.last,n=s[a]||s[a=0];if(n)if(n[0]<t){for(;(e=s[++a])&&e[0]<=t;)n=e;i.last=a-1}else{for(;n&&n[0]>t;)n=s[--a];i.last=a}return n?n[1]:""}};var n=[],r=null;a.prototype={_classes:{list:"fa fa-list",prev:"fa fa-step-backward",play:"fa fa-play",next:"fa fa-step-forward",pause:"fa fa-pause"},themes:["normal","simple"],init:function(){var e=this,s=e.options.container;e.classes=i({},e._classes),e.options.classes&&i(e.classes,e.options.classes),s.classList.add("h5p"),s.innerHTML='<div class="h5p-image"></div><div class="h5p-buttons"><i data-id="list" class="h5p-button '+e.classes.list+'"></i></div><div class="h5p-info"><div class="h5p-title"></div><div class="h5p-artist"></div></div><div class="h5p-control"><i data-id="prev" class="h5p-button '+e.classes.prev+'"></i><i data-id="play" class="h5p-button '+e.classes.play+'"></i><i data-id="next" class="h5p-button '+e.classes.next+'"></i></div><div class="h5p-progress"><div data-id="bar" class="h5p-wrap"><div class="h5p-bar"><div class="h5p-played"></div></div><div class="h5p-cursor"></div><div class="h5p-time"></div></div></div><div class="h5p-lyric"></div><div class="h5p-playlist"></div>';var a=s.querySelector.bind(s);e.image=a(".h5p-image"),e.title=a(".h5p-title"),e.artist=a(".h5p-artist"),e.playlist=a(".h5p-playlist"),e.prcur=a(".h5p-cursor"),e.prtime=a(".h5p-time"),e.brplayed=a(".h5p-played"),e.lyric=a(".h5p-lyric"),e.items={},[].forEach.call(s.querySelectorAll("[data-id]"),function(t){e.items[t.dataset.id]=t}),e.audio=new Audio,e.setSongs([]),e.lyricParser=new t,e.bindEvents(),e.setTheme(e.options.theme)},getPoint:function(t){if("offsetX"in t)return{x:t.offsetX,y:t.offsetY};var e=t.target.getBoundingClientRect(),i=document.documentElement,s=window;return{x:t.pageX-(e.left+s.pageXOffset-i.clientLeft),y:t.pageY-(e.top+s.pageYOffset-i.clientTop)}},bindEvents:function(){var t=this,i=null,a=t.options.container,n={list:t.toggleList,prev:t.playPrev,next:t.playNext,play:t.togglePlay,bar:function(e){p(t.getPoint(e).x,!0)}},o=function(t){t&&t.preventDefault&&(t.preventDefault(),t.stopPropagation())},l=function(e){return function(i){o(i),[].forEach.call(i.changedTouches,function(i){e.call(t,i)})}},c=function(e){for(var i,s=e.target;;){if(i=s.dataset.id,i||s===a)break;s=s.parentNode}var r=i&&n[i];r&&("click"==e.type?(o(e),r.call(t,e)):l(r)(e))};a.addEventListener("touchstart",c,!1),a.addEventListener("click",c,!1),t.audio.addEventListener("ended",t.playAnother.bind(t),!1),t.audio.addEventListener("timeupdate",function(e){var s=this.currentTime,a=t.duration;if(a||(a=t.duration=this.duration),!i){var n=a?s/a*100+"%":0;t.prcur.style.left=n,t.brplayed.style.width=n}t.prtime.innerHTML=t.timestr(s)+" / "+t.timestr(a),t.lyric.innerHTML=t.safeHTML(t.lyricParser.getLyricAtTime(s))},!1);var u=function(i){e({type:i,player:t})},d=function(e){var i=["play","pause"],a=0;"play"==e.type?(s(t),u(e.type)):(a=1,r===t&&(u(e.type),r=null));var n=t.items.play.classList;t.classes[i[a]].split(/\s+/).forEach(function(t){n.remove(t)}),t.classes[i[1-a]].split(/\s+/).forEach(function(t){n.add(t)}),t.image.classList["play"==e.type?"add":"remove"]("h5p-roll")};t.audio.addEventListener("play",d,!1),t.audio.addEventListener("pause",d,!1),t.playlist.addEventListener("click",function(e){o(e);var i=[].indexOf.call(this.childNodes,e.target);i>=0&&t.play(i)},!1);var p=function(e,i){var s=e/t.items.bar.offsetWidth;0>s?s=0:s>1&&(s=1),t.prcur.style.left=t.brplayed.style.width=100*s+"%",i&&(t.audio.currentTime=~~(s*t.duration))},f=function(t){o(t),i.moved=!0,p(t.clientX-i.delta)},v=l(f),h=function(t){o(t),i=null,a.removeEventListener("touchmove",v,!1),a.removeEventListener("mousemove",f,!1),a.removeEventListener("touchend",m,!1),a.removeEventListener("mouseup",y,!1)},y=function(t){p(t.clientX-i.delta,!0),h(t)},m=l(y),L=function(e){o(e),i||(i={delta:e.clientX-t.brplayed.offsetWidth},a.addEventListener("touchmove",v,!1),a.addEventListener("mousemove",f,!1),a.addEventListener("touchend",m,!1),a.addEventListener("mouseup",y,!1))};t.prcur.addEventListener("touchstart",l(L),!1),t.prcur.addEventListener("mousedown",L,!1),t.prcur.addEventListener("click",o,!1)},safeHTML:function(t){return t.replace(/[&"<]/g,function(t){return{"&":"&amp;",'"':"&quot;","<":"&lt;"}[t]})},toggleList:function(t){var e=this;e.items.list.classList.toggle("h5p-active");var i=e.playlist.style.display;e.playlist.style.display=i?"":"block"},togglePlay:function(t){var e=this;e.current<0?e.play(0):e.audio.paused?e.audio.play():e.audio.pause()},playPrev:function(t){this.play(this.previous())},playNext:function(t){this.play(this.next())},playAnother:function(){this.playNext()},setSongs:function(t){var e=this,i=[];e.songs=t,e.songs.forEach(function(t){var s=e.safeHTML(t.name);i.push('<div title="'+s+'">'+s+"</div>")}),e.playlist.innerHTML=i.join(""),e.current=-1,e.audio.src="",e.duration=0,e.showInfo(e.songs[0])},updateInfo:function(t){var e=this,i=e.songs[e.current];t||(t=i||{});var s=t.image;"object"==typeof s&&(s=s[e.theme]),s=s||e.options.image||"",s&&(e.image.innerHTML='<img src="'+e.safeHTML(s)+'">'),e.lyric.innerHTML="","simple"!=e.theme&&i&&e.getLyric(i)},setTheme:function(t){var e=this,i=e.themes.indexOf(t);0>i&&(i=0);var s=e.theme;if(e.theme=e.themes[i],s!=e.theme){var a=e.options.container;a.classList.remove("h5p-"+s),a.classList.add("h5p-"+e.theme),e.updateInfo()}},showInfo:function(t){var e=this;t=t||{},e.updateInfo(t),e.title.innerHTML=e.safeHTML(t.name||""),e.artist.innerHTML=e.safeHTML(t.artist||"")},getLyric:function(t){var e=this;if("lyric"in t)e.lyricParser.setLyric(t.lyric||"");else{e.lyricParser.setLyric();var s=e.options.lyricCallback;if(s){var a=e.current;s(i({},t),function(i){a!=e.current||t.lyric||e.lyricParser.setLyric(t.lyric=i)})}}},play:function(t){var e=this,i=e.songs[Number(t)];if(i||(i=e.songs[t=0]),i){if(e.current==t)e.audio.currentTime=0;else{var s=e.playlist.childNodes,a=s[e.current];a&&a.classList.remove("h5p-active"),e.current=t,s[t].classList.add("h5p-active"),e.audio.src=i.url,e.duration=i.duration?i.duration/1e3:null,e.showInfo(i)}e.prtime.innerHTML="",e.prcur.style.left=0,e.brplayed.style.width=0,e.audio.play()}},previous:function(){return(this.current+this.songs.length-1)%this.songs.length},next:function(){return(this.current+1)%this.songs.length},timestr:function(t){if(isNaN(t))return"??:??";var e=Math.floor(t/60);return t=Math.floor(t)%60,10>t&&(t="0"+t),10>e&&(e="0"+e),e+":"+t},destroy:function(){var t=this;t.lyricParser=null,t.audio.src="",t.audio=null,t.options.container.innerHTML="",t.options.container.classList.remove("h5p");var e=n.indexOf(this);e>=0&&n.splice(e,1)}},window.Player=a}).call({});